# 修改

1. 支持 CDN
主要修改了`modules/storage/hwcloud.go`与`modules/storage/minio.go`使当前服务支持CDN。

2. 更换基础镜像
把`Dockerfile.rootless_cdn`作为当前使用的`Dockerfile`，相较之前的`Dockerfile.rootless`，基础镜像由`docker.io/library/golang:1.21-alpine3.18`改为`openeuler/openeuler:22.03`，随后因软件包管理工具的改变，更换了部分软件包的下载方式。

# 本地部署gitea服务

1. 准备数据库
可参照<https://docs.gitea.com/zh-cn/installation/database-prep>准备数据库

2. 构建镜像
克隆仓库
```
git clone -b feature_cdn https://github.com/opensourceways/gitea.git
```
构建镜像
```
docker build -f ./Dockerfile.rootless_cdn -t gitea . 
```

3. 启动容器和服务
```
docker run -p 8080:3000 --name gitea -itd gitea
docker exec -it gitea /bin/bash
```
> 容器启动后会自动启动gitea服务

4. 访问服务
浏览器访问`<主机ip>:8080`，第一次访问时填写数据库相关信息。之后注册第一个用户，该用户默认为管理员用户。
可以在启动服务的容器中使用`gitea admin user list`可以查看当前所有用户，末尾添加参数`--admin`只查看管理员用户

# k8s部署文件

部署文件：<https://github.com/opensourceways/infra-common/tree/master/common-applications/test-environment/gitea-repo>。各文件作用：
1. namespace.yaml
创建一个`gitea-repo`命名空间，用于隔离 Gitea 的部署。

2. pvc.yaml
创建持久卷声明，定义 Gitea 数据的持久化存储，使数据在 Pod 重新调度或重启时仍然保留。

3. deployment.yaml
部署 Gitea，定义了容器镜像、端口（3000）以及持久卷的声明等，与集群中的实际持久卷绑定。

4. service.yaml
创建 gitea 服务：使用 TCP 协议，在端口 3000 监听请求，并将请求转发到后端名为“gitea-repo”的 pod，其他组件可以通过集群内部的 Cluster IP 访问该服务。

5. ingress.yaml
通过 Ingress 公开 Gitea 服务，将<gitea.test.osinfra.cn>的请求通过 HTTPS/TLS 加密转发到命名空间`gitea-repo`中的服务。设置 nginx Ingress Controller 的代理请求体大小为 10G。
> `nginx.ingress.kubernetes.io/proxy-body-size: 10G`添加该参数后，gitea 仓库支持上传几百M的文件，但仍无法上传1G的文件

6. tls.yaml
配置 TLS 证书和密钥。

7. autoscaler.yaml
用于配置 Kubernetes 的自动扩缩容器（autoscaler）。每天的上午 8 点 30 分至晚上 11 点 55 分之间，将目标资源的副本数调整为 1，以适应不同的负载需求。

8. kustomization.yaml
一次性创建多个 Kubernetes 资源，应用上述7个配置文件。

# OBS桶
pvc.yaml 文件中声明了 OBS 盘和 OBS 桶的配置，它们作为持久卷，在 deployment.yaml 文件中被绑定到路径`/etc/gitea/`和`/etc/gitea-obs/`。
待补充：OBS 桶的使用
